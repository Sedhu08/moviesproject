name: Java CI/CD Pipeline

# This workflow is triggered on every push to the 'main' branch
on:
  push:
    branches: [ master ]
  # Allows manual triggering from the GitHub Actions tab
  workflow_dispatch:

# Define project-wide environment variables
env:
  JAVA_VERSION: '17'
  JAR_PATH: 'target/*.jar' # Assuming your Java project uses Maven and outputs to target/*.jar

jobs:
  ##################################################
  # JOB 1: BUILD AND TEST
  # Compiles the code and creates the deployable artifact.
  ##################################################
  build_and_test:
    runs-on: ubuntu-latest # Executes on a standard Linux virtual machine

    steps:
    - name: 1. Checkout Repository Code
      uses: actions/checkout@v4

    - name: 2. Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven' 

    - name: 3. Build with Maven and Run Tests
      # Compiles, runs tests, and packages the application.
      run: mvn -B package -DskipTests=false
      
    - name: 4. Upload Artifact
      # Makes the compiled JAR file available to the deployment job.
      uses: actions/upload-artifact@v4
      with:
        name: packaged-app
        path: ${{ env.JAR_PATH }}


  ##################################################
  # JOB 2: DEPLOY
  # Runs only if build_and_test succeeds, sends JAR to the server, and restarts the service.
  ##################################################
  deploy:
    needs: build_and_test # Dependency: waits for Job 1 to finish successfully
    runs-on: ubuntu-latest
    
    # Ensures deployment only happens on the main branch push event
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    # Environment variables for deployment (values pulled from GitHub Secrets)
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}        # Server IP Address
      SSH_USER: ${{ secrets.SSH_USER }}        # Server SSH Username
      TARGET_DIR: /var/www/my-java-app/       # Remote server directory
      SERVICE_NAME: my-java-app.service       # Name of the service to restart

    steps:
    - name: 1. Download Artifact
      # Retrieves the JAR file.
      uses: actions/download-artifact@v4
      with:
        name: packaged-app

    - name: 2. Set up SSH Key for Authentication
      # Authenticates using the private key stored as a secret.
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: 3. Deploy JAR via SSH (SCP)
      run: |
        # Creates the directory on the remote server if it doesn't exist
        ssh ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "mkdir -p ${{ env.TARGET_DIR }}"
        
        # Securely copy the new JAR file to the remote server
        scp packaged-app/*.jar ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.TARGET_DIR }}

    - name: 4. Restart Remote Application Service
      run: |
        ssh ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
          echo 'New version deployed. Restarting service...'
          # This command requires the SSH_USER to have sudo permissions for systemctl
          sudo systemctl restart ${{ env.SERVICE_NAME }}
          echo 'Deployment complete.'
        "
